<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Past Simple Homework</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b1220; color: #e9eefc; }
    .topbar {
      position: sticky; top: 0; z-index: 10; background: #0b1220;
      border-bottom: 1px solid #223055;
    }
    .topbar-inner {
      max-width: 900px; margin: 0 auto; padding: 12px 24px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .menu-btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 10px; border: 1px solid #2a3b66;
      background: #1a2b55; color: #e9eefc; cursor: pointer;
    }
    .menu {
      position: absolute; right: 24px; top: 56px; min-width: 200px;
      background: #121b2f; border: 1px solid #223055; border-radius: 12px;
      padding: 6px; display: none; box-shadow: 0 12px 24px rgba(0,0,0,.25);
    }
    .menu.open { display: block; }
    .menu button {
      width: 100%; text-align: left; background: transparent; border: none;
      padding: 10px 12px; border-radius: 8px; color: #e9eefc; cursor: pointer;
    }
    .menu button:hover { background: rgba(255,255,255,.08); }
    .wrap { max-width: 900px; margin: 0 auto; padding: 24px; }
    .card { background: #121b2f; border: 1px solid #223055; border-radius: 14px; padding: 16px; margin: 12px 0; }
    h1 { margin: 0 0 6px; font-size: 26px; }
    .sub { opacity: .9; margin: 0 0 10px; }
    .meta { opacity: .7; font-size: 14px; margin-top: 6px; }
    label { display: block; margin-bottom: 8px; }
    input[type="text"]{
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #2a3b66; background: #0c1427; color: #e9eefc;
      outline: none;
    }
    .opts { display: grid; gap: 8px; }
    .opt {
      display: flex; gap: 10px; align-items: flex-start;
      border: 1px solid #2a3b66; border-radius: 10px; padding: 10px 12px; background: #0c1427;
      cursor: pointer;
    }
    .opt input { margin-top: 3px; }
    .btnbar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid #2a3b66;
      background: #1a2b55; color: #e9eefc; cursor: pointer;
    }
    button:hover { filter: brightness(1.08); }
    .result { margin-top: 10px; padding: 10px 12px; border-radius: 10px; border: 1px dashed #2a3b66; }
    .ok { border-color: #2e8b57; background: rgba(46,139,87,.12); }
    .bad { border-color: #c94b4b; background: rgba(201,75,75,.12); }
    .explain { margin-top: 8px; opacity: .95; line-height: 1.35; }
    .score { font-size: 18px; font-weight: 600; }
    .small { opacity: .8; font-size: 14px; }
    .footer { opacity: .75; font-size: 13px; margin-top: 18px; }
    code { background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">Homework</h1>
      <p class="sub" id="subtitle"></p>
      <div class="meta" id="meta"></div>

      <div class="btnbar">
        <button id="checkBtn">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        <button id="resetBtn" title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ">–°–∫–∏–Ω—É—Ç–∏</button>
        <button id="copyBtn" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
      </div>

      <div class="result" id="overall" style="display:none;"></div>
      <div class="footer" id="footerHint"></div>
    </div>

    <div id="tasks"></div>
  </div>

  <script src="tasks.js"></script>
  <script>
    // ---- Helpers ----
    const $ = (sel) => document.querySelector(sel);

    function normalizeAnswer(s, mode) {
      if (typeof s !== "string") return "";
      let out = s.trim();
      // –±–∞–∑–æ–≤–∞ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è
      out = out.replace(/\s+/g, " ");
      if (mode === "lower") out = out.toLowerCase();
      if (mode === "space") out = out.replace(/\s+/g, " ").trim();
      if (mode === "lower+space") out = out.toLowerCase().replace(/\s+/g, " ").trim();
      return out;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function getTheoryValue(key, fallback) {
      const theory = window.HW?.theory || {};
      const tense = window.HW?.tense;
      if (tense && theory[tense] && theory[tense][key]) return theory[tense][key];
      if (theory[key]) return theory[key];
      return fallback;
    }

    function pickFeedback(task, userRaw) {
      const user = normalizeAnswer(userRaw, "lower+space");
      const fb = task.feedback || {};
      if (fb[user]) return fb[user];
      // —ñ–Ω–∫–æ–ª–∏ —É—á–Ω—ñ –≤–≤–æ–¥—è—Ç—å –∑–∞–π–≤—ñ –∫—Ä–∞–ø–∫–∏/–∫–æ–º–∏
      const cleaned = user.replace(/[.?!,;:]+$/g, "");
      if (fb[cleaned]) return fb[cleaned];
      if (fb["*"]) return fb["*"];
      return getTheoryValue("wrongAnswer", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä –ø—Ä–∞–≤–∏–ª–æ –π —Å–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.");
    }

    function isAccepted(task, userRaw) {
      const normMode = task.normalize ? (task.normalize === "space" ? "lower+space" : "lower+space") : "lower+space";
      const user = normalizeAnswer(userRaw, normMode);

      if (task.type === "fill") {
        const accept = (task.accept || []).map(a => normalizeAnswer(a, normMode));
        return accept.includes(user);
      }
      if (task.type === "mcq") {
        return Number(userRaw) === task.correctIndex;
      }
      return false;
    }

    // ---- Render ----
    function renderMeta() {
      $("#title").textContent = window.HW?.title || "Homework";
      $("#subtitle").textContent = window.HW?.subtitle || "";
      $("#meta").textContent = window.HW?.version ? `–í–µ—Ä—Å—ñ—è: ${window.HW.version}` : "";
      const footer = $("#footerHint");
      if (footer) {
        footer.innerHTML = getTheoryValue(
          "footerHint",
          "–ü–æ—Ä–∞–¥–∞: –∑–≤–µ—Ä—Ç–∞–π —É–≤–∞–≥—É –Ω–∞ —á–∞—Å–æ–≤—ñ –º–∞—Ä–∫–µ—Ä–∏ –≤ —Ä–µ—á–µ–Ω–Ω—ñ —Ç–∞ —Ñ–æ—Ä–º—É –¥—ñ—î—Å–ª–æ–≤–∞."
        );
      }
    }

    function renderTasks(tasks) {
      renderMeta();
      const container = $("#tasks");
      container.innerHTML = "";

      tasks.forEach((task, idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.taskId = task.id;

        const prompt = document.createElement("div");
        prompt.innerHTML = `<div style="font-weight:600; margin-bottom:8px;">${escapeHtml(task.prompt)}</div>`;
        card.appendChild(prompt);

        if (task.type === "fill") {
          const label = document.createElement("label");
          label.innerHTML = `–í—ñ–¥–ø–æ–≤—ñ–¥—å:`;
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "–ù–∞–ø–∏—à–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Ç—É—Ç...";
          input.autocomplete = "off";
          input.dataset.kind = "answer";
          input.dataset.taskId = task.id;
          label.appendChild(input);
          card.appendChild(label);

        } else if (task.type === "mcq") {
          const opts = document.createElement("div");
          opts.className = "opts";

          task.options.forEach((opt, i) => {
            const row = document.createElement("label");
            row.className = "opt";
            row.innerHTML = `
              <input type="radio" name="${task.id}" value="${i}" />
              <div>${escapeHtml(opt)}</div>
            `;
            opts.appendChild(row);
          });

          card.appendChild(opts);
        }

        const result = document.createElement("div");
        result.className = "result";
        result.style.display = "none";
        result.dataset.kind = "result";
        card.appendChild(result);

        container.appendChild(card);
      });
    }

    function getActiveTasks() {
      const activeButton = document.querySelector(
        `#tasksPanel [data-tense].active, #tasksPanel [data-tense][aria-pressed="true"], #tasksPanel [data-tense][aria-selected="true"]`
      );
      const tense = activeButton?.dataset?.tense || window.HW?.tense;
      return window.HW?.taskSets?.[tense] || [];
    }

    function getUserAnswer(task) {
      if (task.type === "fill") {
        const input = document.querySelector(`input[data-kind="answer"][data-task-id="${task.id}"]`);
        return input ? input.value : "";
      }
      if (task.type === "mcq") {
        const checked = document.querySelector(`input[type="radio"][name="${task.id}"]:checked`);
        return checked ? Number(checked.value) : null;
      }
      return "";
    }

    // ---- Check ----
    function checkAll() {
      const tasks = getActiveTasks();
      let correct = 0;

      tasks.forEach(task => {
        const ans = getUserAnswer(task);
        const ok = isAccepted(task, ans);

        const card = document.querySelector(`.card[data-task-id="${task.id}"]`);
        const box = card.querySelector(`div[data-kind="result"]`);

        box.style.display = "block";
        box.classList.remove("ok", "bad");

        if (ok) {
          correct++;
          box.classList.add("ok");
          box.innerHTML = `‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!`;
        } else {
          box.classList.add("bad");

          let explain = "";
          if (task.type === "fill") {
            explain = pickFeedback(task, ans);
          } else if (task.type === "mcq") {
            if (ans === null) {
              explain = "–¢–∏ –Ω—ñ—á–æ–≥–æ –Ω–µ –æ–±—Ä–∞–≤(–ª–∞). –û–±–µ—Ä–∏ –≤–∞—Ä—ñ–∞–Ω—Ç —ñ –ø–µ—Ä–µ–≤—ñ—Ä —â–µ —Ä–∞–∑.";
            } else {
              explain = (task.explanations && task.explanations[ans]) ||
                        getTheoryValue("wrongAnswer", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä –ø—Ä–∞–≤–∏–ª–æ –π —Å–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.");
            }
          }

          box.innerHTML = `‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.<div class="explain">${explain}</div>`;
        }
      });

      const overall = $("#overall");
      overall.style.display = "block";
      overall.className = "result " + (correct === tasks.length ? "ok" : "bad");
      overall.innerHTML = `
        <div class="score">–†–µ–∑—É–ª—å—Ç–∞—Ç: ${correct} / ${tasks.length}</div>
        <div class="small">–ü–æ—Ä–∞–¥–∞: —è–∫—â–æ –±–∞—á–∏—à <b>did/didn't</b> ‚Äî –¥—ñ—î—Å–ª–æ–≤–æ –∑–∞–≤–∂–¥–∏ –≤ <b>V1</b> (–±–µ–∑ -ed).</div>
      `;
    }

    // ---- Reset ----
    function resetAll() {
      const tasks = getActiveTasks();
      tasks.forEach(task => {
        if (task.type === "fill") {
          const input = document.querySelector(`input[data-kind="answer"][data-task-id="${task.id}"]`);
          if (input) input.value = "";
        } else if (task.type === "mcq") {
          document.querySelectorAll(`input[type="radio"][name="${task.id}"]`).forEach(r => r.checked = false);
        }
        const box = document.querySelector(`.card[data-task-id="${task.id}"] div[data-kind="result"]`);
        if (box) {
          box.style.display = "none";
          box.classList.remove("ok", "bad");
          box.innerHTML = "";
        }
      });
      $("#overall").style.display = "none";
      $("#overall").innerHTML = "";
    }

    // ---- Copy results (for students to send teacher) ----
    async function copyResults() {
      const tasks = getActiveTasks();
      const lines = [];
      lines.push(`${window.HW?.title || "Homework"} | version ${window.HW?.version || ""}`);
      tasks.forEach(t => {
        const ans = getUserAnswer(t);
        let a = ans;
        if (t.type === "mcq") {
          a = (ans === null) ? "(no answer)" : `${ans}: ${t.options[ans]}`;
        }
        lines.push(`${t.id} ‚Äî ${t.prompt} => ${a}`);
      });
      const text = lines.join("\n");
      try {
        await navigator.clipboard.writeText(text);
        alert("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ! –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–≤–∏—Ç–∏ –≤ —á–∞—Ç/–ø–æ—à—Ç—É –≤—á–∏—Ç–µ–ª—é üôÇ");
      } catch {
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—å —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –°–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É (–±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ –±–ª–æ–∫—É–≤–∞—Ç–∏).");
      }
    }

    // ---- Init ----
    const sections = {
      home: $("#homeSection"),
      theory: $("#theorySection"),
      tasks: $("#tasksSection")
    };
    const menuBtn = $("#menuBtn");
    const menu = $("#menu");
    const collapseToggles = document.querySelectorAll(".collapse-toggle");

    function setSection(name) {
      Object.entries(sections).forEach(([key, el]) => {
        el.classList.toggle("active", key === name);
      });
      if (name === "theory") {
        openPanel("theoryPanel");
      } else if (name === "tasks") {
        openPanel("tasksPanel");
      }
    }

    function closeMenu() {
      menu.classList.remove("open");
      menuBtn.setAttribute("aria-expanded", "false");
    }

    function toggleMenu() {
      const willOpen = !menu.classList.contains("open");
      menu.classList.toggle("open", willOpen);
      menuBtn.setAttribute("aria-expanded", String(willOpen));
    }

    function openPanel(panelId) {
      document.querySelectorAll(".collapse-content").forEach(panel => {
        const isTarget = panel.id === panelId;
        panel.classList.toggle("open", isTarget);
        const toggle = document.querySelector(`.collapse-toggle[data-collapse="${panel.id}"]`);
        if (toggle) toggle.setAttribute("aria-expanded", String(isTarget));
      });
    }

    function togglePanel(panelId) {
      const panel = document.getElementById(panelId);
      const isOpen = panel.classList.contains("open");
      if (isOpen) {
        panel.classList.remove("open");
        const toggle = document.querySelector(`.collapse-toggle[data-collapse="${panel.id}"]`);
        if (toggle) toggle.setAttribute("aria-expanded", "false");
        return;
      }
      openPanel(panelId);
    }

    renderMeta();
    $("#checkBtn").addEventListener("click", checkAll);
    $("#resetBtn").addEventListener("click", resetAll);
    $("#copyBtn").addEventListener("click", copyResults);

    menuBtn.addEventListener("click", (event) => {
      event.stopPropagation();
      toggleMenu();
    });

    menu.querySelectorAll("button[data-section]").forEach(btn => {
      btn.addEventListener("click", () => {
        setSection(btn.dataset.section);
        closeMenu();
      });
    });

    collapseToggles.forEach(toggle => {
      toggle.addEventListener("click", () => {
        togglePanel(toggle.dataset.collapse);
      });
    });

    document.addEventListener("click", (event) => {
      if (!menu.contains(event.target) && event.target !== menuBtn) {
        closeMenu();
      }
    });

    document.querySelectorAll(`#tasksPanel [data-tense]`).forEach(btn => {
      btn.addEventListener("click", () => {
        window.HW.tense = btn.dataset.tense;
        renderTasks(getActiveTasks());
      });
    });
  </script>
</body>
</html>
<!-- redeploy -->
